<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì±„íŒ… í´ë¼ì´ì–¸íŠ¸</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #log { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; margin-bottom: 10px; }
    #inputArea { display: flex; gap: 10px; }
    #inputArea input, #inputArea button { font-size: 1rem; }
  </style>
</head>
<body>

<h1>WebSocket ì±„íŒ… í´ë¼ì´ì–¸íŠ¸</h1>

<label>
  í† í°:
  <input id="token" placeholder="JWT Token" style="width: 400px">
</label>
<button onclick="connect()">ì„œë²„ ì—°ê²°</button>

<div id="log"></div>

<div id="inputArea">
  <input id="chatroomId" type="number" placeholder="ì±„íŒ…ë°© ID">
  <input id="message" placeholder="ë³´ë‚¼ ë©”ì‹œì§€">
  <button onclick="sendMessage()">ì „ì†¡</button>
</div>

<script>
  let socket;

  function log(msg) {
    const el = document.getElementById('log');
    el.textContent += msg + '\n';
    el.scrollTop = el.scrollHeight;
  }

  function connect() {
    const token = document.getElementById('token').value.trim();
    if (!token) return alert("í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.");

    socket = new WebSocket(`ws://localhost:3000?token=${token}`);

    socket.addEventListener('open', () => log('âœ… ì„œë²„ì— ì—°ê²°ë¨'));
    socket.addEventListener('message', (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'receivedChat') {
        log(`ğŸ’¬ [ë°›ìŒ] ì±„íŒ…ë°© ${data.chatroomId} â†’ ${data.content}`);
      } else if (data.type === 'unreadChats') {
        data.chats.forEach(chat => {
          log(`ğŸ“¨ [ì•ˆì½ìŒ] ì±„íŒ…ë°© ${chat.chatroomId} â†’ ${chat.content}`);
        });
      } else if (data.type === 'error') {
        log(`âŒ ì˜¤ë¥˜: ${data.message}`);
      }
    });
    socket.addEventListener('close', () => log('ğŸ”Œ ì—°ê²° ì¢…ë£Œë¨'));
    socket.addEventListener('error', (e) => log('âš  ì—°ê²° ì˜¤ë¥˜: ' + e.message));
  }

  function sendMessage() {
    if (!socket || socket.readyState !== WebSocket.OPEN) {
      return alert('ì„œë²„ì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }
    const chatroomId = parseInt(document.getElementById('chatroomId').value, 10);
    const content = document.getElementById('message').value.trim();
    if (!chatroomId || !content) return alert("ì±„íŒ…ë°© IDì™€ ë©”ì‹œì§€ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");

    const payload = {
      type: 'sentChat',
      chatroomId,
      content,
    };
    socket.send(JSON.stringify(payload));
    document.getElementById('message').value = '';
  }
</script>

</body>
</html>
